data:
  preprocessed:
    - tests/data/advection/preprocessed
  train:
    - tests/data/advection/preprocessed/train/0
    # - tests/data/advection/preprocessed/train
  validation:
    - tests/data/advection/preprocessed/train/0
    # - tests/data/advection/preprocessed/validation
inferer:
  write_simulation: true
  write_simulation_base: tests/data/advection/interim
  write_simulation_type: 'vtu'
trainer:
  # clip_grad_norm: 1.0
  output_directory: tests/data/advection/nonlinear_dggnn
  inputs:
    rank0:
      - name: cell_initial_phi
        dim: 1
    boundary:
      - name: facet_periodic_flag
        dim: 1
    inverse_boundary:
      - name: facet_inverse_periodic_flag
        dim: 1
    speed:
      - name: cell_speed
        dim: 1
  support_inputs:
    - signed_inc_cell2facet
    - weighted_normal_inc_facet2cell_x
    - weighted_normal_inc_facet2cell_y
    - weighted_normal_inc_facet2cell_z
  outputs:
    - name: cell_phi
      dim: 1
      time_series: true
      time_slice:
        - 1
        - 11
        - 1
  prune: true
  batch_size: 1
  n_epoch: 1000
  log_trigger_epoch: 10
  stop_trigger_epoch: 10
  seed: 0
  lazy: false
  num_workers: 0
  optimizer_setting:
    lr: 1.0e-3
model:
  blocks:
    - name: IN_RANK0
      type: mlp
      is_first: true
      bias: false
      input_keys:
        - rank0
      output_key: grank0
      destinations:
        - GROUP1
      nodes:
        - -1
        - 4
      activations:
        - identity
    - name: IN_BOUNDARY
      type: identity
      is_first: true
      input_keys:
        - boundary
      output_key: gboundary
      destinations:
        - GROUP1
    - name: IN_INVERSE_BOUNDARY
      type: identity
      is_first: true
      input_keys:
        - inverse_boundary
      output_key: ginverse_boundary
      destinations:
        - GROUP1
    - name: IN_SPEED
      type: mlp
      is_first: true
      bias: false
      input_keys:
        - speed
      output_key: gspeed
      destinations:
        - GROUP1
      nodes:
        - -1
        - 4
      activations:
        - identity

    - name: GROUP1
      type: group
      destinations:
        - DECODER

    - name: DECODER
      type: pinv_mlp
      input_keys:
        - grank0
      reference_block_name: IN_RANK0

  groups:
    - name: GROUP1
      debug: false
      repeat: 2
      mode: implicit
      convergence_threshold: 1.0e-10
      time_series_length: 10
      inputs:
        grank0:
          - name: IN_RANK0
            dim: 4
            skip: false
        gboundary:
          - name: IN_BOUNDARY
            dim: 1
            skip: true
        ginverse_boundary:
          - name: IN_INVERSE_BOUNDARY
            dim: 1
            skip: true
        gspeed:
          - name: IN_SPEED
            dim: 4
            skip: true
      support_inputs:
        - signed_inc_cell2facet
        - weighted_normal_inc_facet2cell_x
        - weighted_normal_inc_facet2cell_y
        - weighted_normal_inc_facet2cell_z
      outputs:
        grank0:
          - name: OUT_LINEAR
            dim: 4
      blocks:
        - name: DGGNN_CELL2FACET
          type: dggnn
          # coeff: 100
          is_first: true
          input_keys:
            - grank0
          destinations:
            - BOUNDARY
            - INVERSE_BOUNDARY
          bias: false
          support_input_indices:
            - 0
            - 1
            - 2
            - 3
          nodes:
            - 4
            - 4
            - 4
          activations:
            - tanh
            - identity
          optional:
            propagations:
              - spread
            riemann_solver: lax_friedrichs
            use_mlp: true
        - name: IN_BOUNDARY
          type: identity
          is_first: true
          input_keys:
            - gboundary
          destinations:
            - BOUNDARY
        - name: BOUNDARY
          type: projection
          input_names:
            - DGGNN_CELL2FACET
            - IN_BOUNDARY
          destinations:
            - MEAN
          optional:
            operator: mean
        - name: IN_INVERSE_BOUNDARY
          type: identity
          is_first: true
          input_keys:
            - ginverse_boundary
          destinations:
            - INVERSE_BOUNDARY
        - name: INVERSE_BOUNDARY
          type: projection
          input_names:
            - DGGNN_CELL2FACET
            - IN_INVERSE_BOUNDARY
          destinations:
            - MEAN
          optional:
            operator: mean
        - name: MEAN
          type: reducer
          coeff: 0.5  # Mean
          destinations:
            - MUL
          optional:
            operator: add
        - name: DGGNN_SPEED_CELL2FACET
          type: dggnn
          # coeff: 100
          is_first: true
          input_keys:
            - gspeed
          destinations:
            - MUL
          bias: false
          support_input_indices:
            - 0
            - 1
            - 2
            - 3
          nodes:
            - 4
            - 4
          activations:
            - identity
          optional:
            propagations:
              - spread
            trainable: true
        - name: MUL
          type: reducer
          destinations:
            - DGGNN_FACET2CELL
          optional:
            operator: mul
        - name: DGGNN_FACET2CELL
          type: dggnn
          output_key: grank0
          support_input_indices:
            - 0
            - 1
            - 2
            - 3
          nodes:
            - 4
            - 4
            - 4
          activations:
            - tanh
            - identity
          optional:
            propagations:
              - contraction
